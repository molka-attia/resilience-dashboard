<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kubernetes Monitoring Dashboard - KPI Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
  :root {
    --primary: #1867b7;
    --secondary: #A8A5E6;
    --accent: #FF7675;
    --bg: #0F0F1E;
    --card-bg: rgba(255, 255, 255, 0.08);
    --sidebar-bg: rgba(16, 16, 32, 0.95);
    --text-color: #fff;
    --input-bg: rgba(0, 0, 0, 0.3);
    --border-color: rgba(255, 255, 255, 0.1);
    --nav-hover: rgba(108, 92, 231, 0.1);
    --shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
    --table-bg: rgba(0, 0, 0, 0.3);
    --scrollbar-thumb: rgba(108, 92, 231, 0.5);
    --scrollbar-track: transparent;
    --pagination-active: #1867b7;
    --pagination-hover: rgba(24, 103, 183, 0.1);
    --chart-bg: rgba(0, 0, 0, 0.3);
    --chart-text: #fff;
    --chart-grid: rgba(255, 255, 255, 0.1);
    --chart-legend-text: #fff;
    --legend-instance-color: #A8A5E6;
  }

  .light-mode {
    --primary: #1867b7;
    --secondary: #7986CB;
    --accent: #FF5252;
    --bg: #f5f5f5;
    --card-bg: rgba(255, 255, 255, 0.9);
    --sidebar-bg: rgba(255, 255, 255, 0.95);
    --text-color: #333;
    --input-bg: rgba(0, 0, 0, 0.05);
    --border-color: rgba(0, 0, 0, 0.1);
    --nav-hover: rgba(92, 107, 192, 0.1);
    --shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    --table-bg: #fff;
    --scrollbar-thumb: rgba(92, 107, 192, 0.5);
    --pagination-hover: rgba(24, 103, 183, 0.05);
    --chart-bg: #fff;
    --chart-text: #333;
    --chart-grid: rgba(0, 0, 0, 0.1);
    --chart-legend-text: #333;
    --legend-instance-color: #3f51b5;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    transition: all 0.3s ease;
  }

  .sidebar {
    width: 280px;
    height: 100vh;
    background: var(--sidebar-bg);
    padding: 2rem 1.5rem;
    position: fixed;
    left: 0;
    top: 0;
    z-index: 10;
    backdrop-filter: blur(12px);
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }

  .sidebar h1 {
    font-size: 1.8rem;
    margin-bottom: 2.5rem;
    background: linear-gradient(45deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
  }

  .nav-links {
    flex-grow: 1;
  }

  .nav-link {
    color: var(--text-color);
    opacity: 0.9;
    text-decoration: none;
    margin: 0.8rem 0;
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
  }

  .nav-link::before {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 0;
    height: 2px;
    background: var(--primary);
    transition: width 0.3s ease;
  }

  .nav-link:hover {
    background: var(--nav-hover);
    transform: translateX(8px);
    opacity: 1;
  }

  .nav-link:hover::before {
    width: 100%;
  }

  .theme-toggle {
    background: var(--card-bg);
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 12px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: auto;
    margin-bottom: 1rem;
  }

  .theme-toggle:hover {
    background: var(--nav-hover);
  }

  .copyright {
    font-size: 0.8rem;
    color: var(--text-color);
    opacity: 0.6;
    text-align: center;
  }

  .main {
    flex: 1;
    margin-left: 280px;
    min-height: 100vh;
    padding: 2rem;
    transition: all 0.3s ease;
  }

  .card {
    background: var(--card-bg);
    backdrop-filter: blur(24px);
    border: 1px solid var(--border-color);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: var(--shadow);
    width: 100%;
    transition: all 0.3s ease;
    margin-bottom: 2rem;
  }

  .card h2 {
    margin-bottom: 2rem;
    text-align: left;
    background: linear-gradient(45deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: center;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    min-width: 200px;
  }

  label {
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    opacity: 0.8;
    color: var(--text-color);
  }

  select, input {
    padding: 0.8rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.9rem;
  }

  button.fetch-btn {
    padding: 0.8rem 1.5rem;
    background: linear-gradient(135deg, var(--primary), #8175FF);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    align-self: flex-end;
    height: fit-content;
  }

  button.fetch-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
  }

  .chart-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .pod-selector {
    flex-grow: 1;
    min-width: 300px;
  }

  .pod-selector select {
    width: 100%;
    height: 120px;
  }

  .charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 2.5rem;
    margin-top: 2rem;
    row-gap: 3rem;
  }

  .chart-container {
    width: 100%;
    height: 400px;
    background: #7f9faf;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
  }

  .legend-container {
    max-height: 150px;
    overflow-y: auto;
    padding: 0.75rem;
    background: var(--card-bg);
    border-radius: 8px;
    margin-top: 1rem;
    border: 1px solid var(--border-color);
    font-size: 0.9rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    margin: 0.3rem 0;
    cursor: pointer;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .legend-item:hover {
    background-color: var(--nav-hover);
  }

  .legend-color {
    width: 16px;
    height: 16px;
    margin-right: 8px;
    border-radius: 3px;
  }

  .legend-label {
    display: flex;
    align-items: center;
  }

  .legend-label .instance {
    color: var(--legend-instance-color);
    font-weight: 700;
    margin-left: 5px;
  }

  .notification {
    position: fixed;
    bottom: 2rem;
    right: -300px;
    background: var(--card-bg);
    padding: 1.2rem 2rem;
    border-radius: 12px;
    border-left: 4px solid var(--primary);
    backdrop-filter: blur(12px);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: var(--shadow);
    color: var(--text-color);
  }

  .notification.show {
    right: 2rem;
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      height: auto;
      position: relative;
    }

    .main {
      margin-left: 0;
      padding: 1.5rem;
    }

    .controls {
      flex-direction: column;
      align-items: stretch;
    }

    .charts-grid {
      grid-template-columns: 1fr;
      gap: 2rem;
      row-gap: 2.5rem;
    }

    .chart-container {
      padding: 1rem;
    }

    .legend-container {
      max-height: 120px;
      margin-top: 0.75rem;
    }
  }
</style>
</head>
<body>
  <div class="sidebar">
    <div class="nav-links">
      <h1>‚ö° K8s Chaos</h1>
      <a href="index.html" class="nav-link">
        <span>üìä Chaos Graph</span>
      </a>
      <a href="kpi.html" class="nav-link active">
        <span>üìà KPI Dashboard</span>
      </a>
      <a href="faultsinjections.html" class="nav-link">
        <span>üß™ Fault Injection</span>
      </a>
      <a href="metrics-dash.html" class="nav-link">
        <span>üìè CPU Usage</span>
      </a>
      <a href="metrics-system-usage.html" class="nav-link">
        <span>üñ•Ô∏è CPU System</span>
      </a>
      <a href="memory_working_set_bytes.html" class="nav-link">
        <span>üéØ Active Memory</span>
      </a>
      <a href="container_network_receive_bytes.html" class="nav-link">
        <span>üåê Network Receive</span>
      </a>
      <a href="network_transmit_packets.html" class="nav-link">
        <span>üì° Network Transmit</span>
      </a>
      
      <a href="events.html" class="nav-link">
        <span>üìã Events</span>
      </a>
    </div>
    <button class="theme-toggle" id="themeToggle">
      <span>üåì</span> <span>Toggle Theme</span>
    </button>
    <div class="copyright">¬© 2025 UPM Kubernetes Dashboard</div>
  </div>

  <div class="main">
    <div class="card">
      <h2>üìà KPI Dashboard</h2>

      <div class="controls">
        <div class="control-group">
          <label for="namespace">Namespace</label>
          <select id="namespace">
            <option value="">Loading namespaces...</option>
          </select>
        </div>
        <div class="control-group">
          <label for="start">Start Time</label>
          <input type="datetime-local" id="start" />
        </div>
        <div class="control-group">
          <label for="end">End Time</label>
          <input type="datetime-local" id="end" />
        </div>
        <button class="fetch-btn" onclick="fetchData()">Load Data</button>
      </div>

      <div class="chart-controls">
        <div class="control-group pod-selector">
          <label for="podSelect">Select Pods to Display (required)</label>
          <select id="podSelect" multiple size="5" required>
            <option value="">Select pods after loading data</option>
          </select>
        </div>
        <button class="fetch-btn" onclick="updateChartsWithSelectedPods()">Show Graphs</button>
      </div>

      <div class="charts-grid">
        <div class="chart-container">
          <canvas id="qpsChart"></canvas>
          <div class="legend-container" id="qpsLegend"></div>
        </div>
        <div class="chart-container">
          <canvas id="throughputChart"></canvas>
          <div class="legend-container" id="throughputLegend"></div>
        </div>
        <div style="margin-top: 20%;" class="chart-container">
          <canvas id="errorRateChart"></canvas>
          <div class="legend-container" id="errorRateLegend"></div>
        </div>
        <div style="margin-top: 20%;" class="chart-container">
          <canvas id="latencyChart"></canvas>
          <div class="legend-container" id="latencyLegend"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script>
    let charts = {
      qps: null,
      throughput: null,
      errorRate: null,
      latency: null
    };
    let allPods = new Set();
    let podSeriesData = {
      qps: [],
      throughput: [],
      errorRate: [],
      latency: []
    };

    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      const isLight = document.body.classList.contains('light-mode');
      localStorage.setItem('lightMode', isLight);
      updateChartColors();
    });
    if (localStorage.getItem('lightMode') === 'true') {
      document.body.classList.add('light-mode');
    }

    function showNotification(message, success = true) {
      const notif = document.getElementById('notification');
      notif.style.backgroundColor = success ? 'rgba(40, 167, 69, 0.15)' : 'rgba(220, 53, 69, 0.15)';
      notif.style.borderColor = success ? '#28a745' : '#dc3545';
      notif.innerHTML = (success ? '‚úÖ ' : '‚ùå ') + message;
      notif.classList.add('show');
      setTimeout(() => notif.classList.remove('show'), 3000);
    }

    function updatePodSelector() {
      const podSelect = document.getElementById('podSelect');
      podSelect.innerHTML = '';
      const sortedPods = Array.from(allPods).sort();
      sortedPods.forEach(pod => {
        const series = podSeriesData.qps.find(s => s.pod === pod) || 
                       podSeriesData.throughput.find(s => s.pod === pod) || 
                       podSeriesData.errorRate.find(s => s.pod === pod) || 
                       podSeriesData.latency.find(s => s.pod === pod) || { node: '-' };
        const node = series.node || '-';
        const option = document.createElement('option');
        option.value = pod;
        option.textContent = `${pod} (Node: ${node})`;
        option.selected = true;
        podSelect.appendChild(option);
      });
    }

    function updateChartsWithSelectedPods() {
      const podSelect = document.getElementById('podSelect');
      const selectedPods = Array.from(podSelect.selectedOptions).map(opt => opt.value);
      
      if (selectedPods.length === 0) {
        showNotification("Please select at least one pod to display the graphs.", false);
        document.querySelectorAll('.chart-container').forEach(c => c.style.display = 'none');
        return;
      }

      const kpis = ['qps', 'throughput', 'errorRate', 'latency'];
      let hasData = false;
      kpis.forEach(kpi => {
        const filteredSeries = podSeriesData[kpi].filter(series => selectedPods.includes(series.pod));
        if (filteredSeries.length > 0) {
          document.getElementById(`${kpi}Chart`).parentElement.style.display = 'block';
          renderChart(kpi, filteredSeries);
          hasData = true;
        } else {
          document.getElementById(`${kpi}Chart`).parentElement.style.display = 'none';
        }
      });

      if (hasData) {
        showNotification("Graphs updated successfully.", true);
      } else {
        showNotification("No data available for selected pods.", false);
      }
    }

    function renderChart(kpi, pods) {
      const ctx = document.getElementById(`${kpi}Chart`).getContext("2d");
      const colors = [
        "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728",
        "#9467bd", "#8c564b", "#e377c2", "#7f7f7f",
        "#bcbd22", "#17becf", "#aec7e8", "#ffbb78",
        "#98df8a", "#ff9896", "#c5b0d5", "#c49c94",
        "#f7b6d2", "#c7c7c7", "#dbdb8d", "#9edae5"
      ];

      pods.sort((a, b) => a.pod.localeCompare(b.pod));
      
      const datasets = pods.map((p, i) => ({
        label: `${p.pod} (Node: ${p.node || '-'})`,
        data: p.rates.map(d => ({ x: d.timestamp, y: d.rate })),
        borderColor: colors[i % colors.length],
        backgroundColor: colors[i % colors.length] + '33',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 5,
        fill: false,
        tension: 0.1,
      }));

      if (charts[kpi]) charts[kpi].destroy();

      const kpiConfig = {
        qps: {
          title: 'Queries Per Second (QPS) per Pod',
          yAxis: 'QPS (queries/s)',
          valueFormat: value => value.toFixed(2),
          tooltipLabel: 'QPS'
        },
        throughput: {
          title: 'Throughput per Pod',
          yAxis: 'Throughput (B/s)',
          valueFormat: value => value.toFixed(2),
          tooltipLabel: 'Throughput'
        },
        errorRate: {
          title: 'Error Rate per Pod',
          yAxis: 'Error Rate (%)',
          valueFormat: value => value.toFixed(2),
          tooltipLabel: 'Error Rate'
        },
        latency: {
          title: 'Latency per Pod',
          yAxis: 'Latency (ms)',
          valueFormat: value => value.toFixed(2),
          tooltipLabel: 'Latency'
        }
      };

      charts[kpi] = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: kpiConfig[kpi].title,
              color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
              font: { size: 14 }
            },
            legend: { display: false },
            tooltip: {
              mode: 'nearest',
              intersect: false,
              backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim(),
              titleColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
              bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
              borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim(),
              borderWidth: 1,
              padding: 10,
              callbacks: {
                title: function(context) {
                  return new Date(context[0].parsed.x).toLocaleString();
                },
                label: function(context) {
                  const [pod, nodePart] = context.dataset.label.split(' (Node: ');
                  const node = nodePart ? nodePart.slice(0, -1) : '-';
                  return [
                    `Pod: ${pod}`,
                    `Node: ${node}`,
                    `${kpiConfig[kpi].tooltipLabel}: ${kpiConfig[kpi].valueFormat(context.parsed.y)} ${kpiConfig[kpi].yAxis.split(' ')[1]}`
                  ];
                }
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            x: {
              type: 'time',
              time: { 
                tooltipFormat: 'MMM dd, yyyy HH:mm:ss',
                unit: 'minute'
              },
              title: { 
                display: true, 
                text: 'Timestamp', 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim() 
              },
              grid: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() 
              },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              beginAtZero: true,
              title: { 
                display: true, 
                text: kpiConfig[kpi].yAxis, 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim() 
              },
              grid: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() 
              },
              ticks: { 
                color: getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim(),
                callback: kpiConfig[kpi].valueFormat
              }
            }
          },
          animation: { duration: 0 },
          hover: { animationDuration: 0 },
          responsiveAnimationDuration: 0
        }
      });

      updateCustomLegend(kpi);
      charts[kpi].update();
    }

    function updateCustomLegend(kpi) {
      const legendContainer = document.getElementById(`${kpi}Legend`);
      legendContainer.innerHTML = '';
      
      charts[kpi].data.datasets.forEach((dataset, i) => {
        const legendItem = document.createElement('div');
        legendItem.className = 'legend-item';
        legendItem.dataset.index = i;
        
        const legendColor = document.createElement('div');
        legendColor.className = 'legend-color';
        legendColor.style.backgroundColor = dataset.borderColor;
        
        const legendLabel = document.createElement('span');
        legendLabel.className = 'legend-label';
        const [pod, nodePart] = dataset.label.split(' (Node: ');
        const node = nodePart ? nodePart.slice(0, -1) : '-';
        legendLabel.innerHTML = `${pod} <span class="instance">(Node: ${node})</span>`;
        
        legendItem.appendChild(legendColor);
        legendItem.appendChild(legendLabel);
        legendContainer.appendChild(legendItem);
        
        legendItem.addEventListener('click', function() {
          const index = parseInt(this.dataset.index);
          const meta = charts[kpi].getDatasetMeta(index);
          
          meta.hidden = !meta.hidden;
          charts[kpi].update();
          
          if (meta.hidden) {
            this.style.opacity = '0.5';
          } else {
            this.style.opacity = '1';
          }
        });
      });
    }

async function fetchData() {
  const namespace = document.getElementById("namespace").value;
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  if (!namespace || !start || !end) {
    showNotification("Please fill in all fields: namespace, start, and end datetime.", false);
    return;
  }

  const btn = document.querySelector('.fetch-btn');
  btn.disabled = true;
  btn.textContent = 'Loading...';

  try {
    const queries = {
      qps: `rate(istio_requests_total{destination_service_namespace="${namespace}"}[1m])`,
      throughput: `rate(istio_request_bytes_sum{destination_service_namespace="${namespace}"}[1m]) + rate(istio_response_bytes_sum{destination_service_namespace="${namespace}"}[1m])`,
      errorRate: `100 * rate(istio_requests_total{destination_service_namespace="${namespace}", response_code=~"5.."}[1m]) / rate(istio_requests_total{destination_service_namespace="${namespace}"}[1m])`,
      latency: `rate(istio_request_duration_milliseconds_sum{destination_service_namespace="${namespace}"}[1m]) / rate(istio_requests_total{destination_service_namespace="${namespace}"}[1m])`
    };

    allPods.clear();
    for (const kpi of Object.keys(queries)) {
      podSeriesData[kpi] = [];
      const url = `http://raphtory03:9090/api/v1/query_range?query=${encodeURIComponent(queries[kpi])}&start=${new Date(start).toISOString()}&end=${new Date(end).toISOString()}&step=15s`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status} for ${kpi} query`);
      }
      const data = await response.json();

      if (!data.data.result.length) {
        console.warn(`No data found for ${kpi} in namespace ${namespace}`);
        showNotification(`No data found for ${kpi.toUpperCase()}.`, false);
        continue;
      }

      for (const series of data.data.result) {
        const pod = series.metric.destination_app || series.metric.pod || "-";
        let node = series.metric.kubernetes_node || series.metric.instance || "-";
        if (node === "i want") {
          node = "node1";
        }
        if (node !== "-" && node.includes(':')) {
          node = node.split(':')[0]; // Clean up node if it includes port
        }
        if (pod === "-") {
          console.warn(`Missing pod or destination_app label for ${kpi} metric:`, series.metric);
          showNotification(`Some ${kpi} metrics are missing pod labels.`, false);
          continue;
        }
        const rates = series.values.map(([ts, val]) => {
          let rate = parseFloat(val);
          if (kpi === 'throughput') {
           // rate = rate / (1024 * 1024); // Convert bytes to MB
          } else if (kpi === 'errorRate' && (isNaN(rate) || rate === null)) {
            rate = 0; // Handle division by zero or undefined error rates
          }
          return {
            timestamp: new Date(ts * 1000),
            rate
          };
        }).filter(v => !isNaN(v.rate) && v.rate !== null && v.rate !== undefined);

        if (rates.length > 0) {
          podSeriesData[kpi].push({ pod, node, rates });
          allPods.add(pod);
        }
      }
    }

    if (allPods.size === 0) {
      showNotification("No valid pod data found for any KPI. Check namespace or time range.", false);
      document.querySelectorAll('.chart-container').forEach(c => c.style.display = 'none');
    } else {
      updatePodSelector();
      document.querySelectorAll('.chart-container').forEach(c => c.style.display = 'none');
      showNotification("Data loaded. Please select pods to display the graphs.", true);
    }
  } catch (error) {
    console.error("Failed to fetch data:", error);
    showNotification("Error fetching data. Check console for details.", false);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Load Data';
  }
} 

function updateChartColors() {
      const chartText = getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim();
      const chartGrid = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim();
      const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
      
      for (const kpi of Object.keys(charts)) {
        if (charts[kpi]) {
          charts[kpi].options.plugins.title.color = chartText;
          charts[kpi].options.scales.x.title.color = chartText;
          charts[kpi].options.scales.x.ticks.color = chartText;
          charts[kpi].options.scales.x.grid.color = chartGrid;
          charts[kpi].options.scales.y.title.color = chartText;
          charts[kpi].options.scales.y.ticks.color = chartText;
          charts[kpi].options.scales.y.grid.color = chartGrid;
          charts[kpi].options.plugins.tooltip.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
          charts[kpi].options.plugins.tooltip.titleColor = chartText;
          charts[kpi].options.plugins.tooltip.bodyColor = chartText;
          charts[kpi].options.plugins.tooltip.borderColor = borderColor;
          charts[kpi].update();
        }
      }
    }

    async function fetchNamespaces() {
      const url = 'http://raphtory03:9090/api/v1/label/namespace/values';
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status} for namespace query`);
        }
        const data = await response.json();

        if (!data || !data.data) {
          console.error("No namespaces found.");
          showNotification("No namespaces found. Check Prometheus configuration.", false);
          return;
        }

        const namespaces = data.data;
        const namespaceSelect = document.getElementById("namespace");
        namespaceSelect.innerHTML = '<option value="">Select Namespace</option>';
        namespaces.forEach(namespace => {
          const option = document.createElement("option");
          option.value = namespace;
          option.textContent = namespace;
          namespaceSelect.appendChild(option);
        });

        setDefaultDatetimes();
      } catch (error) {
        console.error("Failed to fetch namespaces:", error);
        showNotification("Error fetching namespaces. Using fallback.", false);
        // Fallback to manual namespace input
        const namespaceSelect = document.getElementById("namespace");
        namespaceSelect.innerHTML = '<option value="">Enter Namespace Manually</option>';
        namespaceSelect.disabled = false;
      }
    }

    function setDefaultDatetimes() {
      const now = new Date();
      const oneHourAgo = new Date(now.getTime() - (60 * 60 * 1000));
      
      document.getElementById('start').value = formatDateTimeLocal(oneHourAgo);
      document.getElementById('end').value = formatDateTimeLocal(now);
    }

    function formatDateTimeLocal(date) {
      return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 16);
    }

    window.onload = fetchNamespaces;
  </script>
</body>
</html>